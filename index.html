<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>p5.js example</title>
    <style>
      body {
        padding: 0;
        margin: 0;
      }

      .panel {
        border: 4px solid saddlebrown;
        background-color: yellow;
        width: 300px;
        margin-left: auto;
        margin-right: 0;
        font-size: 1.4em;
      }
    </style>
    <script src="p5.js"></script>
    <script src="p5.dom.js"></script>
    <script src="p5.sound.js"></script>
    <script src="matrices.js"></script>

    <script>
      const shapes = {
        square: [
          [[0], [0], [1]],
          [[100], [0], [1]],
          [[100], [100], [1]],
          [[0], [100], [1]]
        ]
      };

      const shape = shapes.square;
      let tShape = [...shape];

      const Transformations = {
        yReflection: [[-1, 0, 0], [0, 1, 0], [0, 0, 1]],
        xReflection: [[1, 0, 0], [0, -1, 0], [0, 0, 1]],
        xScale(factor) {
          return [[factor, 0, 0], [0, 1, 0], [0, 0, 1]];
        },
        yScale(factor) {
          return [[1, 0, 0], [0, factor, 0], [0, 0, 1]];
        },
        rotation(angle) {
          const sin = Math.sin((angle * 2 * Math.PI) / 360);
          const cos = Math.cos((angle * 2 * Math.PI) / 360);

          return [[cos, -sin, 0], [sin, cos, 0], [0, 0, 1]];
        },
        compute(params) {
          const { rotation, xReflection, yReflection, xScale, yScale } = params;
          for (let i = 0; i < shape.length; i++) {
            tShape[i] = shape[i];

            // compute rotation
            tShape[i] = Matrices.multiply(
              Transformations.rotation(rotation),
              tShape[i]
            );

            // compute reflections
            if (yReflection) {
              tShape[i] = Matrices.multiply(
                Transformations.yReflection,
                tShape[i]
              );
            }
            if (xReflection) {
              tShape[i] = Matrices.multiply(
                Transformations.xReflection,
                tShape[i]
              );
            }

            // compute scaling
            tShape[i] = Matrices.multiply(
                    Transformations.xScale(xScale),
                    tShape[i]
            );
            tShape[i] = Matrices.multiply(
                    Transformations.yScale(yScale),
                    tShape[i]
            );
          }

          printVertex(tShape);
        }
      };

      const Panel = {
        initialize(element) {
          this.container = document.querySelector(element);
          this.container.addEventListener(
            "change",
            this.handleChange.bind(this)
          );
          const resetButton = this.container.querySelector('.resetButton');
          resetButton.addEventListener('click', this.resetState.bind(this));
          this.initialState = this.getState();
        },
        getState() {
          const state = {};
          const inputs = this.container.querySelectorAll("input");
          for (let input of inputs) {
            if (input.type === "checkbox") {
              state[input.name] = input.checked;
            } else {
              state[input.name] = input.value;
            }
          }
          return state;
        },
        resetState() {
          const state = this.initialState;
          const inputs = this.container.querySelectorAll("input");
          for (let input of inputs) {
            if (input.type === "checkbox") {
              input.checked = state[input.name];
            } else {
              input.value = state[input.name];
            }
          }
          this.handleChange();
        },
        handleChange() {
          const panelState = this.getState();
          Transformations.compute(panelState);
        }
      };

      function printVertex(s) {
        for (let i = 0; i < s.length; i++) {
          console.table(s[i]);
        }
      }
    </script>
    <script src="sketch.js"></script>
  </head>
  <body>
    <div class="panel">
      <label>
        Rotation:
        <input
          type="range"
          name="rotation"
          class="rotation"
          min="0"
          max="360"
          value="0"
        />
      </label>
      <br />
      <label>
        Y axis reflection:
        <input type="checkbox" name="yReflection" class="yReflection" />
      </label>
      <br />
      <label>
        X axis reflection:
        <input type="checkbox" name="xReflection" class="xReflection" />
      </label>
      <br />
      <label>
        X scale:
        <input
          type="range"
          name="xScale"
          class="xScale"
          min="0.1"
          max="3"
          value="1"
          step="0.1"
        />
      </label>
      <br />
      <label>
        Y scale:
        <input
          type="range"
          name="yScale"
          class="yScale"
          min="0.1"
          max="3"
          value="1"
          step="0.1"
        />
      </label>
      <br />
      <button type="button" class="resetButton">Reset</button>
    </div>

    <script>
      Panel.initialize(".panel");
    </script>
  </body>
</html>
